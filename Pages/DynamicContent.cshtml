@page "/{category}/{slug}"
@model MocInformacji.Pages.DynamicContentModel
@{
    ViewData["Title"] = Model.Content?.Title ?? "Artykuł";
    ViewData["MetaDescription"] = Model.Content?.MetaDescription ?? "";
}

@if (Model.Content == null)
{
    <div class="container py-5 text-center">
        <div class="error-404">
            <h1 class="display-1 fw-bold">404</h1>
            <p class="lead mb-4">Nie znaleźliśmy tego, czego szukasz.</p>
            <a href="/" class="btn btn-primary btn-lg px-5">
                <i class="bi bi-house me-2"></i>
                Wróć na stronę główną
            </a>
        </div>
    </div>
}
else
{
    <!-- Breadcrumb -->
    <div class="breadcrumb-section">
        <div class="container">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/"><i class="bi bi-house"></i> Home</a></li>
                    <li class="breadcrumb-item"><a href="/@Model.Category" class="text-capitalize">@Model.Category</a></li>
                    <li class="breadcrumb-item active">@Model.Content.H1</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="container py-4">
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <article class="article-main">
                    <!-- Featured Image -->
                    @if (!string.IsNullOrEmpty(Model.Content.FeaturedImage))
                    {
                        <div class="article-featured-image mb-4">
                            <img src="@Model.Content.FeaturedImage" alt="@Model.Content.Title" class="img-fluid" loading="lazy" data-category="@Model.Category" />
                        </div>
                    }
                    
                    <!-- Article Header -->
                    <header class="article-header">
                        <div class="article-category">
                            <i class="bi bi-folder-fill"></i>
                            <span>#@Model.Category</span>
                        </div>
                        <h1 class="article-title">@Model.Content.H1</h1>
                        <div class="article-meta-info">
                            <div class="meta-item">
                                <i class="bi bi-calendar-check"></i>
                                <span>@Model.Content.LastModified.ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("pl-PL"))</span>
                            </div>
                            <div class="meta-item">
                                <i class="bi bi-clock"></i>
                                <span>@Model.CalculateReadingTime(Model.Content.WordCount) min czytania</span>
                            </div>
                            <div class="meta-item">
                                <i class="bi bi-person-circle"></i>
                                <span>Ekspert MocInformacji</span>
                            </div>
                        </div>
                    </header>

                    <!-- Mobile TOC -->
                    <div id="toc-mobile" class="toc-mobile d-lg-none"></div>

                    <!-- Article Content -->
                    <div class="article-content">
                        @Html.Raw(Model.Content.Article)
                    </div>

                    <!-- FAQ Section -->
                    @if (Model.FAQ.Any())
                    {
                        <div class="faq-section" id="faq">
                            <div class="faq-header">
                                <h2>
                                    <i class="bi bi-question-circle-fill"></i>
                                    Często zadawane pytania (FAQ)
                                </h2>
                                <p>Odpowiedzi na najczęściej zadawane pytania dotyczące tego tematu</p>
                            </div>
                            
                            <div class="faq-accordion">
                                @for (int i = 0; i < Model.FAQ.Count; i++)
                                {
                                    <div class="faq-item">
                                        <button class="faq-question" type="button" data-faq-target="faq-@i">
                                            <span class="faq-question-text">@Model.FAQ[i].Question</span>
                                            <i class="bi bi-chevron-down faq-icon"></i>
                                        </button>
                                        <div class="faq-answer" id="faq-@i">
                                            <div class="faq-answer-content">
                                                @Model.FAQ[i].Answer
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Share Section -->
                    <div class="article-share">
                        <h3>Udostępnij artykuł</h3>
                        <div class="share-buttons">
                            <button class="share-btn facebook" onclick="shareOn('facebook')">
                                <i class="bi bi-facebook"></i>
                                <span>Facebook</span>
                            </button>
                            <button class="share-btn twitter" onclick="shareOn('twitter')">
                                <i class="bi bi-twitter-x"></i>
                                <span>Twitter</span>
                            </button>
                            <button class="share-btn linkedin" onclick="shareOn('linkedin')">
                                <i class="bi bi-linkedin"></i>
                                <span>LinkedIn</span>
                            </button>
                            <button class="share-btn copy" onclick="copyLink()">
                                <i class="bi bi-link-45deg"></i>
                                <span>Kopiuj link</span>
                            </button>
                        </div>
                    </div>
                </article>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <div class="sidebar-sticky">
                    <!-- Table of Contents -->
                    <div id="toc-desktop" class="toc-sidebar d-none d-lg-block">
                        <div class="toc-header">
                            <h3>
                                <i class="bi bi-list-ul"></i>
                                Spis treści
                            </h3>
                        </div>
                        <div class="toc-content"></div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="reading-progress d-none d-lg-block">
                        <div class="progress-label">Postęp czytania</div>
                        <div class="progress">
                            <div class="progress-bar" id="readingProgressBar"></div>
                        </div>
                    </div>

                    <!-- Promo Box -->
                    <div class="promo-box">
                        <div class="promo-icon">
                            <i class="bi bi-question-circle"></i>
                        </div>
                        <h4>Masz pytania?</h4>
                        <p>Nasza baza wiedzy rośnie każdego dnia!</p>
                        <a href="/" class="btn btn-primary w-100">
                            Przeglądaj kategorie
                            <i class="bi bi-arrow-right ms-2"></i>
                        </a>
                    </div>

                    <!-- Newsletter Box -->
                    <div class="newsletter-box">
                        <h4>
                            <i class="bi bi-envelope-heart"></i>
                            Newsletter
                        </h4>
                        <p>Otrzymuj najnowsze artykuły na swoją skrzynkę</p>
                        <form>
                            <input type="email" class="form-control mb-2" placeholder="Twój email" />
                            <button type="submit" class="btn btn-dark w-100">
                                Zapisz się
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Generate Table of Contents
            generateTableOfContents();
            
            // Setup FAQ accordion
            setupFAQ();
            
            // Setup reading progress
            setupReadingProgress();
            
            // Smooth scroll for TOC links
            setupSmoothScroll();
        });

        function generateTableOfContents() {
            const content = document.querySelector('.article-content');
            if (!content) return;
            
            const headings = content.querySelectorAll('h2, h3');
            const tocDesktop = document.querySelector('#toc-desktop .toc-content');
            const tocMobile = document.getElementById('toc-mobile');

            if (headings.length === 0) {
                document.getElementById('toc-desktop')?.remove();
                document.getElementById('toc-mobile')?.remove();
                return;
            }

            const tocList = document.createElement('ul');
            tocList.className = 'toc-list';

            headings.forEach((heading, index) => {
                const id = 'heading-' + index;
                heading.id = id;
                
                const li = document.createElement('li');
                li.className = 'toc-item ' + (heading.tagName === 'H3' ? 'toc-item-sub' : '');
                
                const link = document.createElement('a');
                link.href = '#' + id;
                link.className = 'toc-link';
                link.textContent = heading.textContent;
                
                li.appendChild(link);
                tocList.appendChild(li);
            });

            // Clone for both desktop and mobile
            if (tocDesktop) {
                tocDesktop.appendChild(tocList.cloneNode(true));
            }
            
            if (tocMobile) {
                const mobileTitle = document.createElement('div');
                mobileTitle.className = 'toc-mobile-header';
                mobileTitle.innerHTML = '<i class="bi bi-list-ul"></i> Spis treści';
                tocMobile.appendChild(mobileTitle);
                tocMobile.appendChild(tocList);
            }

            // Highlight active section
            highlightActiveTocItem();
        }

        function setupFAQ() {
            const faqButtons = document.querySelectorAll('.faq-question');
            
            faqButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-faq-target');
                    const answer = document.getElementById(targetId);
                    const isOpen = this.classList.contains('active');
                    
                    // Close all other FAQs
                    document.querySelectorAll('.faq-question').forEach(btn => {
                        btn.classList.remove('active');
                        const ans = document.getElementById(btn.getAttribute('data-faq-target'));
                        if (ans) ans.style.maxHeight = '0';
                    });
                    
                    // Toggle current FAQ
                    if (!isOpen) {
                        this.classList.add('active');
                        answer.style.maxHeight = answer.scrollHeight + 'px';
                    }
                });
            });
        }

        function setupReadingProgress() {
            const progressBar = document.getElementById('readingProgressBar');
            if (!progressBar) return;
            
            window.addEventListener('scroll', function() {
                const article = document.querySelector('.article-content');
                if (!article) return;
                
                const articleTop = article.offsetTop;
                const articleHeight = article.offsetHeight;
                const windowHeight = window.innerHeight;
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                const progress = Math.min(
                    100,
                    Math.max(0, ((scrollTop - articleTop + windowHeight) / articleHeight) * 100)
                );
                
                progressBar.style.width = progress + '%';
            });
        }

        function highlightActiveTocItem() {
            const headings = document.querySelectorAll('.article-content h2, .article-content h3');
            const tocLinks = document.querySelectorAll('.toc-link');
            
            window.addEventListener('scroll', function() {
                let current = '';
                
                headings.forEach(heading => {
                    const rect = heading.getBoundingClientRect();
                    if (rect.top <= 150) {
                        current = heading.id;
                    }
                });
                
                tocLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === '#' + current) {
                        link.classList.add('active');
                    }
                });
            });
        }

        function setupSmoothScroll() {
            document.querySelectorAll('.toc-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href').substring(1);
                    const target = document.getElementById(targetId);
                    
                    if (target) {
                        const offsetTop = target.offsetTop - 100;
                        window.scrollTo({
                            top: offsetTop,
                            behavior: 'smooth'
                        });
                    }
                });
            });
        }

        function shareOn(platform) {
            const url = encodeURIComponent(window.location.href);
            const title = encodeURIComponent(document.title);
            
            let shareUrl = '';
            
            switch(platform) {
                case 'facebook':
                    shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
                    break;
                case 'twitter':
                    shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
                    break;
                case 'linkedin':
                    shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
                    break;
            }
            
            if (shareUrl) {
                window.open(shareUrl, '_blank', 'width=600,height=400');
            }
        }

        function copyLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                const btn = event.target.closest('.share-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check2"></i><span>Skopiowano!</span>';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            });
        }
    </script>
}

<style>
    /* Breadcrumb */
    .breadcrumb-section {
        background: white;
        border-bottom: 1px solid var(--gray-200);
        padding: 1rem 0;
    }
    
    .breadcrumb {
        background: transparent;
        margin: 0;
        padding: 0;
    }
    
    .breadcrumb-item a {
        color: var(--gray-700);
        text-decoration: none;
        transition: color 0.2s;
    }
    
    .breadcrumb-item a:hover {
        color: var(--primary-color);
    }
    
    .breadcrumb-item.active {
        color: var(--gray-700);
    }

    /* Article Main */
    .article-main {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Featured Image */
    .article-featured-image {
        margin: -2rem -2rem 2rem -2rem;
        border-radius: 1rem 1rem 0 0;
        overflow: hidden;
        max-height: 500px;
    }
    
    .article-featured-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* Article Header */
    .article-header {
        margin-bottom: 2.5rem;
        padding-bottom: 2rem;
        border-bottom: 2px solid var(--gray-200);
    }
    
    .article-category {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--primary-color);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 1.5rem;
    }
    
    .article-title {
        font-size: 2.5rem;
        font-weight: 900;
        color: var(--gray-900);
        line-height: 1.2;
        margin-bottom: 1.5rem;
    }
    
    .article-meta-info {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--gray-700);
        font-size: 0.9375rem;
    }
    
    .meta-item i {
        color: var(--primary-color);
        font-size: 1.125rem;
    }

    /* Mobile TOC */
    .toc-mobile {
        background: var(--gray-100);
        border: 1px solid var(--gray-200);
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .toc-mobile-header {
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.125rem;
    }

    /* Article Content */
    .article-content {
        font-size: 1.125rem;
        line-height: 1.8;
        color: var(--gray-800);
    }
    
    .article-content h2 {
        font-size: 1.875rem;
        font-weight: 800;
        margin-top: 3rem;
        margin-bottom: 1.5rem;
        color: var(--gray-900);
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--gray-200);
    }
    
    .article-content h3 {
        font-size: 1.5rem;
        font-weight: 700;
        margin-top: 2.5rem;
        margin-bottom: 1.25rem;
        color: var(--gray-900);
    }
    
    .article-content p {
        margin-bottom: 1.5rem;
    }
    
    .article-content ul,
    .article-content ol {
        margin-bottom: 1.5rem;
        padding-left: 1.5rem;
    }
    
    .article-content li {
        margin-bottom: 0.75rem;
    }
    
    .article-content strong {
        color: var(--gray-900);
        font-weight: 700;
    }
    
    .article-content a {
        color: var(--primary-color);
        text-decoration: underline;
    }
    
    .article-content a:hover {
        color: var(--primary-dark);
    }

    /* FAQ Section */
    .faq-section {
        margin-top: 3rem;
        padding: 2rem;
        background: var(--gray-50);
        border-radius: 1rem;
        border: 1px solid var(--gray-200);
    }
    
    .faq-header {
        margin-bottom: 2rem;
    }
    
    .faq-header h2 {
        font-size: 1.75rem;
        font-weight: 800;
        color: var(--gray-900);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .faq-header h2 i {
        color: var(--primary-color);
    }
    
    .faq-header p {
        color: var(--gray-700);
        margin: 0;
    }
    
    .faq-accordion {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .faq-item {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: 0.75rem;
        overflow: hidden;
        transition: all 0.3s;
    }
    
    .faq-item:hover {
        border-color: var(--primary-color);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .faq-question {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        padding: 1.25rem 1.5rem;
        background: transparent;
        border: none;
        text-align: left;
        font-size: 1.0625rem;
        font-weight: 600;
        color: var(--gray-900);
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .faq-question:hover {
        color: var(--primary-color);
    }
    
    .faq-icon {
        flex-shrink: 0;
        font-size: 1.25rem;
        color: var(--primary-color);
        transition: transform 0.3s;
    }
    
    .faq-question.active .faq-icon {
        transform: rotate(180deg);
    }
    
    .faq-answer {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }
    
    .faq-answer-content {
        padding: 0 1.5rem 1.25rem 1.5rem;
        color: var(--gray-700);
        line-height: 1.7;
    }

    /* Share Section */
    .article-share {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 2px solid var(--gray-200);
    }
    
    .article-share h3 {
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--gray-900);
    }
    
    .share-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }
    
    .share-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1.25rem;
        border: 1px solid var(--gray-300);
        border-radius: 0.5rem;
        background: white;
        color: var(--gray-900);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .share-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .share-btn.facebook:hover {
        background: #1877f2;
        border-color: #1877f2;
        color: white;
    }
    
    .share-btn.twitter:hover {
        background: #000000;
        border-color: #000000;
        color: white;
    }
    
    .share-btn.linkedin:hover {
        background: #0a66c2;
        border-color: #0a66c2;
        color: white;
    }
    
    .share-btn.copy:hover {
        background: var(--success-color);
        border-color: var(--success-color);
        color: white;
    }

    /* Sidebar */
    .sidebar-sticky {
        position: sticky;
        top: 100px;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    /* TOC Sidebar */
    .toc-sidebar {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: 0.75rem;
        padding: 1.5rem;
        max-height: 60vh;
        overflow-y: auto;
    }
    
    .toc-header {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--gray-200);
    }
    
    .toc-header h3 {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--gray-900);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .toc-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .toc-item {
        margin-bottom: 0.75rem;
    }
    
    .toc-item-sub {
        margin-left: 1.25rem;
        margin-bottom: 0.5rem;
    }
    
    .toc-link {
        display: block;
        color: var(--gray-700);
        text-decoration: none;
        font-size: 0.9375rem;
        line-height: 1.5;
        padding: 0.375rem 0;
        transition: all 0.2s;
        border-left: 2px solid transparent;
        padding-left: 0.75rem;
    }
    
    .toc-link:hover {
        color: var(--primary-color);
        border-left-color: var(--primary-color);
    }
    
    .toc-link.active {
        color: var(--primary-color);
        font-weight: 600;
        border-left-color: var(--primary-color);
    }

    /* Reading Progress */
    .reading-progress {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: 0.75rem;
        padding: 1.5rem;
    }
    
    .progress-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: 0.75rem;
    }
    
    .reading-progress .progress {
        height: 8px;
        background: var(--gray-200);
        border-radius: 1rem;
    }
    
    .reading-progress .progress-bar {
        background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        border-radius: 1rem;
        transition: width 0.1s ease;
    }

    /* Promo Box */
    .promo-box {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        border-radius: 0.75rem;
        padding: 2rem;
        text-align: center;
    }
    
    .promo-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.9;
    }
    
    .promo-box h4 {
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 0.75rem;
    }
    
    .promo-box p {
        margin-bottom: 1.5rem;
        opacity: 0.9;
    }
    
    .promo-box .btn {
        background: white;
        color: var(--primary-color);
        border: none;
        font-weight: 600;
    }
    
    .promo-box .btn:hover {
        background: var(--gray-100);
    }

    /* Newsletter Box */
    .newsletter-box {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: 0.75rem;
        padding: 1.5rem;
    }
    
    .newsletter-box h4 {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .newsletter-box h4 i {
        color: var(--primary-color);
    }
    
    .newsletter-box p {
        color: var(--gray-700);
        font-size: 0.9375rem;
        margin-bottom: 1rem;
    }

    /* Responsive */
    @media (max-width: 991px) {
        .article-main {
            padding: 1.5rem;
        }
        
        .article-featured-image {
            margin: -1.5rem -1.5rem 1.5rem -1.5rem;
        }
        
        .article-title {
            font-size: 2rem;
        }
        
        .article-content {
            font-size: 1.0625rem;
        }
        
        .article-content h2 {
            font-size: 1.5rem;
        }
        
        .article-content h3 {
            font-size: 1.25rem;
        }
        
        .sidebar-sticky {
            position: static;
        }
    }

    @media (max-width: 576px) {
        .article-title {
            font-size: 1.75rem;
        }
        
        .meta-item {
            font-size: 0.875rem;
        }
        
        .share-buttons {
            flex-direction: column;
        }
        
        .share-btn {
            width: 100%;
            justify-content: center;
        }
    }

    /* Custom Scrollbar for TOC */
    .toc-sidebar::-webkit-scrollbar {
        width: 6px;
    }
    
    .toc-sidebar::-webkit-scrollbar-track {
        background: var(--gray-100);
        border-radius: 3px;
    }
    
    .toc-sidebar::-webkit-scrollbar-thumb {
        background: var(--gray-300);
        border-radius: 3px;
    }
    
    .toc-sidebar::-webkit-scrollbar-thumb:hover {
        background: var(--gray-700);
    }

    /* Error 404 */
    .error-404 {
        padding: 5rem 0;
    }
    
    .error-404 h1 {
        font-size: 8rem;
        color: var(--gray-300);
        font-weight: 900;
    }
</style>
